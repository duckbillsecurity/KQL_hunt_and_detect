# Active Directory NTDS.dit Exfiltration Detection (KQL)

## 1. Process & File Detections

### Detecting Shadow Copy Creation
The most obvious indicator is the use of `Win32_ShadowCopy` or `vssadmin`. Even when done "natively" via PowerShell, it triggers WMI/CIM events.

```kql
DeviceProcessEvents
| where ProcessCommandLine has_any ("Win32_ShadowCopy", "vssadmin", "create shadow")
| where ProcessCommandLine has "C:"
| project TimeGenerated, DeviceName, AccountName, ProcessCommandLine


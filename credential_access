Detecting Shadow Copy Creation
The most obvious indicator is the use of Win32_ShadowCopy or vssadmin. Even when done "natively" via PowerShell, it triggers WMI/CIM events.
```
DeviceProcessEvents
| where ProcessCommandLine has_any ("Win32_ShadowCopy", "vssadmin", "create shadow")
| where ProcessCommandLine has "C:"
| project TimeGenerated, DeviceName, AccountName, ProcessCommandLine
```

Detecting the Symbolic Link to GLOBALROOT
Creating a symbolic link to the GLOBALROOT device path is a high-fidelity indicator of credential dumping, as there are very few legitimate reasons for a user to do this.
```
DeviceProcessEvents
| where ProcessCommandLine has "mklink" and ProcessCommandLine has "GLOBALROOT\\Device\\HarddiskVolumeShadowCopy"
| project TimeGenerated, DeviceName, AccountName, ProcessCommandLine
```

Detecting Access to the NTDS.dit File
If you have File Inventory or Advanced Hunting enabled, you can see when a process (like cmd.exe or powershell.exe) touches the ntds.dit file outside of the standard lsass.exe or services.exe processes.
```
DeviceFileEvents
| where FileName =~ "ntds.dit"
| where FolderPath !has "Windows\\NTDS" // Looking for the "staged" copy
| project TimeGenerated, DeviceName, RequestingProcessCommandLine, FolderPath, FileName
```

The "Gold Standard" Combined Hunting Query
This query looks for the specific pattern of PowerShell (Invoke-Command) being used to touch the sensitive paths and the shadow copy volume in the same timeframe.
```
union DeviceProcessEvents, DeviceNetworkEvents
| where ProcessCommandLine has_all ("ShadowCopy", "ntds.dit", "SYSTEM", "SECURITY")
    or (ProcessCommandLine has "mklink" and ProcessCommandLine has "Temp")
| summarize FirstSeen = min(TimeGenerated), LastSeen = max(TimeGenerated) by DeviceName, AccountName, ProcessCommandLine
| sort by FirstSeen desc
```

The "NTDS Dumping" Sequence
If you want to create a single Analytics Rule that has a very low false-positive rate, you can use a join to find both events happening on the same host within a short window (e.g., 10 minutes).
```
let LinkCreated = 
    DeviceProcessEvents
    | where ProcessCommandLine has_all ("mklink", "shadowcopy", "HarddiskVolumeShadowCopy")
    | project LinkTime = TimeGenerated, DeviceName, AccountName;
let FileStaged = 
    DeviceFileEvents
    | where FileName =~ "ntds.dit" and FolderPath !has "Windows\\NTDS"
    | project StageTime = TimeGenerated, DeviceName, StagedPath = FolderPath, RequestingProcess = RequestingProcessCommandLine;
LinkCreated
| join kind=inner FileStaged on DeviceName
| where StageTime between (LinkTime .. (LinkTime + 10m))
| project LinkTime, StageTime, DeviceName, AccountName, StagedPath, RequestingProcess

Monitor PowerShell Script Blocks
Because you used Invoke-Command, the commands above might appear as wsmprovhost.exe (the WinRM worker process). To see the actual code inside the script block, you should query the PowerShell logs (if you are collecting Event ID 4104):
```
Event
| where EventLog == "Microsoft-Windows-PowerShell/Operational" and EventID == 4104
| where RenderedDescription has_any ("Win32_ShadowCopy", "ntds.dit", "SYSTEM_stage")
| project TimeGenerated, Computer, RenderedDescription
```

```

KQL Detection (Sentinel)
Once enabled, Sentinel can see the actual commands passed inside the ScriptBlock. This query catches the specific code we used earlier:
```
Event
| where EventLog == "Microsoft-Windows-PowerShell/Operational" and EventID == 4104
| parse RenderedDescription with * "ScriptBlock Text: " ScriptContent
| where ScriptContent has_any ("Win32_ShadowCopy", "ntds.dit", "mklink", "shadowcopy")
| project TimeGenerated, Computer, User = UserName, ScriptContent
```

Alert on "TrustedHosts" Changes
Attackers often modify TrustedHosts to bypass WinRM authentication hurdles (as we saw in your earlier error). Monitoring for this prevents an attacker from making the DC more "reachable" from an unauthorized IP.
A. The KQL Detection (Registry & Process)
We can look for the command line or the registry modification that happens when Set-Item is run against the WSMan provider.
```
DeviceProcessEvents
| where ProcessCommandLine has "TrustedHosts" 
    and ProcessCommandLine has_any ("Set-Item", "Set-ChildItem", "reg add")
| project TimeGenerated, DeviceName, AccountName, ProcessCommandLine
```
B. The KQL Detection (Configuration Changes)
If you are collecting Registry Events, you can monitor the exact location where WinRM stores these settings:
DeviceRegistryEvents
| where RegistryKey has @"SOFTWARE\Microsoft\Windows\CurrentVersion\WSMAN\Client"
    and RegistryValueName == "trusted_hosts"
| project TimeGenerated, DeviceName, AccountName, PreviousRegistryValueData, RegistryValueData


